From 9e0574adfd9566ed6308291e4917b095a238fa79 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Mon, 27 May 2019 17:16:29 -0700
Subject: [PATCH 4/5] Fix bug #77988 - heap-buffer-overflow on php_jpg_get16

(cherry picked from commit 73ff4193be24192c894dc0502d06e2b2db35eefb)
---
 NEWS                         |  14 ++++++++++++++
 ext/exif/exif.c              |   2 ++
 ext/exif/tests/bug77988.jpg  | Bin 0 -> 1202 bytes
 ext/exif/tests/bug77988.phpt |  11 +++++++++++
 4 files changed, 27 insertions(+)
 create mode 100644 ext/exif/tests/bug77988.jpg
 create mode 100644 ext/exif/tests/bug77988.phpt

diff --git a/ext/exif/exif.c b/ext/exif/exif.c
index 15e091b6c5..b6c31773ab 100644
--- a/ext/exif/exif.c
+++ b/ext/exif/exif.c
@@ -3536,6 +3536,8 @@ static int exif_scan_thumbnail(image_info_type *ImageInfo TSRMLS_DC)
 		if (c == 0xFF)
 			return FALSE;
 		marker = c;
+		if (pos>=ImageInfo->Thumbnail.size)
+			return FALSE;
 		length = php_jpg_get16(data+pos);
 		if (length > ImageInfo->Thumbnail.size || pos >= ImageInfo->Thumbnail.size - length) {
 			return FALSE;
#diff --git a/ext/exif/tests/bug77988.jpg b/ext/exif/tests/bug77988.jpg
#new file mode 100644
#index 0000000000000000000000000000000000000000..120ff8565a87d82e9e3fcfd5d819df0043faebb5
#GIT binary patch
#literal 1202
#zcmex=!+=4+00sR2$H0dqz<`C1s)OPGL#COo6`5%a48Fb$S_}*f91KiNGZ>hFECV1`
#zo74tp`vdtINTwUGFo1aw5?KPo4)ybN_IGi`lw@FHVq{<en#BmjZA?sXHVa7G{~P}q
#znCkz7m~imlfT0D>88F8G1DJjpFvkp1i-V}?E_k#vfKvwfMq3iC6&S~YV8zUEEkIWQ
#ft^aSpXb%^nl%Ywf0W{L@K_hcP#{R#>z-#~j#VP6c
#
#literal 0
#HcmV?d00001
#
diff --git a/ext/exif/tests/bug77988.phpt b/ext/exif/tests/bug77988.phpt
new file mode 100644
index 0000000000..1632c8afaa
--- /dev/null
+++ b/ext/exif/tests/bug77988.phpt
@@ -0,0 +1,11 @@
+--TEST--
+Bug #77988 (heap-buffer-overflow on php_jpg_get16)
+--SKIPIF--
+<?php if (!extension_loaded('exif')) print 'skip exif extension not available';?>
+--FILE--
+<?php
+exif_read_data(__DIR__."/bug77988.jpg", 'COMMENT', FALSE, TRUE);
+?>
+DONE
+--EXPECTF--
+DONE
\ No newline at end of file
-- 
2.20.1

